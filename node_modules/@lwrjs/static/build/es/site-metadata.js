import path from 'path';
import fs from 'fs-extra';
import { logger } from '@lwrjs/shared-utils';
const SITE_METADATA_PATH = '.metadata';
const STATIC_BUNDLE_METADATA_PATH = path.join(SITE_METADATA_PATH, '/bundle-metadata.json');
const STATIC_RESOURCE_METADATA_PATH = path.join(SITE_METADATA_PATH, '/resource-metadata.json');
const STATIC_ASSET_METADATA_PATH = path.join(SITE_METADATA_PATH, '/asset-metadata.json');
export class SiteMetadataImpl {
    constructor(options) {
        this.options = options;
        this.siteBundles = this.readStaticBundleMetadata(options.rootDir);
        this.siteResources = this.readStaticResourceMetadata(options.rootDir);
        this.siteAssets = this.readStaticAssetsMetadata(options.rootDir);
    }
    getSiteRootDir() {
        return this.options.rootDir;
    }
    getSiteBundles() {
        return this.siteBundles;
    }
    getSiteResources() {
        return this.siteResources;
    }
    getSiteAssets() {
        return this.siteAssets;
    }
    async persistSiteMetadata() {
        // Create the metadata directory if if does not exist
        const siteMetadataPath = path.join(this.options.rootDir, SITE_METADATA_PATH);
        try {
            if (!(await fs.pathExists(siteMetadataPath))) {
                await fs.mkdir(siteMetadataPath, { recursive: true });
            }
            // Save Bundle Metadata
            const bundleMetadataPath = path.join(this.options.rootDir, STATIC_BUNDLE_METADATA_PATH);
            await fs.writeJSON(bundleMetadataPath, this.siteBundles, { spaces: 2 });
            // Save Resource Metadata
            const resourceMetadataPath = path.join(this.options.rootDir, STATIC_RESOURCE_METADATA_PATH);
            await fs.writeJSON(resourceMetadataPath, this.siteResources, { spaces: 2 });
            // Save Resource Metadata
            const assetMetadataPath = path.join(this.options.rootDir, STATIC_ASSET_METADATA_PATH);
            return fs.writeJSON(assetMetadataPath, this.siteAssets, { spaces: 2 });
        }
        catch (err) {
            console.error(`[SiteMetadata] Failed to save site metadata ${siteMetadataPath}`);
            console.error(err);
        }
    }
    readStaticBundleMetadata(staticRoot) {
        let bundleMetadataPath;
        let siteBundles = { bundles: {} };
        try {
            bundleMetadataPath = path.join(staticRoot, STATIC_BUNDLE_METADATA_PATH);
            const savedMetadata = fs.readJSONSync(bundleMetadataPath);
            siteBundles = savedMetadata;
        }
        catch (error) {
            if (error.code === 'ENOENT') {
                logger.debug(`[SiteMetadata] Failed to load Static Bundle Metadata: ${bundleMetadataPath}`);
            }
            else {
                throw error;
            }
        }
        return siteBundles;
    }
    /**
     * Read the metadata about the pre-built resources of the current site.
     */
    readStaticResourceMetadata(staticRoot) {
        let resourceMetadataPath;
        let siteResources = { resources: {} };
        try {
            resourceMetadataPath = path.join(staticRoot, STATIC_RESOURCE_METADATA_PATH);
            const savedMetadata = fs.readJSONSync(resourceMetadataPath);
            siteResources = savedMetadata;
        }
        catch (error) {
            if (error.code === 'ENOENT') {
                logger.debug(`[SiteMetadata] Failed to load Static Resource Metadata: ${resourceMetadataPath}`);
            }
            else {
                throw error;
            }
        }
        return siteResources;
    }
    /**
     * Read the metadata about the pre-built assets of the current site.
     */
    readStaticAssetsMetadata(staticRoot) {
        let assetMetadataPath;
        let siteAssets = {
            assets: {},
        };
        try {
            assetMetadataPath = path.join(staticRoot, STATIC_ASSET_METADATA_PATH);
            siteAssets = fs.readJSONSync(assetMetadataPath);
        }
        catch (error) {
            if (error.code === 'ENOENT') {
                logger.debug(`[SiteMetadata] Failed to load Static Resource Metadata: ${assetMetadataPath}`);
            }
            else {
                throw error;
            }
        }
        return siteAssets;
    }
}
//# sourceMappingURL=site-metadata.js.map